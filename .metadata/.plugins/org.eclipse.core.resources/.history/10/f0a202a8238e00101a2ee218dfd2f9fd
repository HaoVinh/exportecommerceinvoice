package vinh.lixco.com.apiecommerce;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.UUID;
import java.util.logging.Logger;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import javax.inject.Inject;
import javax.ws.rs.Consumes;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.HttpHeaders;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;

import lixco.com.entity.Customer;
import lixco.com.entity.EcomOrder;
import lixco.com.entity.EcomOrderDetail;
import lixco.com.entity.Invoice;
import lixco.com.entity.InvoiceDetail;
import lixco.com.entity.PricingProgram;
import lixco.com.entity.PricingProgramDetail;
import lixco.com.entity.Product;
import lixco.com.interfaces.ICustomerPricingProgramService;
import lixco.com.interfaces.ICustomerService;
import lixco.com.interfaces.IPricingProgramDetailService;
import lixco.com.interfaces.IPricingProgramService;
import lixco.com.interfaces.IProductService;
import lixco.com.service.EcomOrderDetailService;
import lixco.com.service.EcomOrderService;
import lixco.com.service.InvoiceDetailService;
import lixco.com.service.InvoiceService;

@Path("shopee")
public class ShopeeAPIServlet {

	private static final long PARTNER_ID = 2012115L;
	private static final String API_PARTNER_KEY = "shpk76694e444a51764f786775544b7a64446577784f7652476b72556b485163";
	private static final long SHOP_ID = 779607831L;
	private static final Logger LOGGER = Logger.getLogger(ShopeeAPIServlet.class.getName());
	private static final ObjectMapper mapper = new ObjectMapper();
	private static final String BASE_URL = "https://partner.shopeemobile.com";

	@Inject
	private EcomOrderService ecomOrderService;

	@Inject
	private ShopeeTokenManager shopeeTokenManager;

	@Inject
	private EcomOrderDetailService ecomOrderDetailService;

	@Inject
	private InvoiceService invoiceService;

	@Inject
	private InvoiceDetailService invoiceDetailService;

	@POST
	@Path("/webhook/order")
	@Consumes(MediaType.APPLICATION_JSON)
	@Produces(MediaType.APPLICATION_JSON)
	public Response webhookShopee(@Context HttpHeaders headers, String inputJson) {
		LOGGER.info("Webhook Shopee: " + inputJson);
		try {
			JsonNode jsonNode = mapper.readTree(inputJson);
			JsonNode dataNode = jsonNode.path("data");

			if (dataNode.has("verify_info")) {
				ObjectNode verifyResp = mapper.createObjectNode();
				verifyResp.put("code", 0);
				verifyResp.put("message", "Verified OK");
				return Response.ok(verifyResp).build();
			}

			String orderSn = dataNode.path("ordersn").asText(null);
			String status = dataNode.path("status").asText(null);
			long updateTime = dataNode.path("update_time").asLong(0);

			if (orderSn == null || orderSn.trim().isEmpty() || status == null || status.trim().isEmpty()) {
				throw new IllegalArgumentException("Missing or invalid ordersn or status in Shopee webhook");
			}
			OrderDTO orderDTO = new OrderDTO();
			orderDTO.setOrderId(orderSn);
			orderDTO.setOrder_status(status);
			orderDTO.setUpdatedAt(updateTime > 0 ? new Date(updateTime * 1000) : new Date());
			orderDTO.seteCommerceType("Shopee");

			try {
				OrderDTO fetchedDTO = fetchOrder(orderSn);
				if (fetchedDTO != null) {
					String webhookStatus = status;
					Date webhookUpdateTime = updateTime > 0 ? new Date(updateTime * 1000) : new Date();
					// copy dữ liệu cần từ API sang orderDTO
					orderDTO = fetchedDTO;
					orderDTO.setOrder_status(webhookStatus); // luôn dùng trạng thái từ webhook
					orderDTO.setUpdatedAt(webhookUpdateTime);
					orderDTO.setDataJson(inputJson);
				}
			} catch (Exception e) {
				LOGGER.warning("Failed to fetch order or escrow details for orderSn: " + orderSn + ", error: "
						+ e.getMessage());
			}
			saveOrUpdateOrder(orderDTO); // Lưu cả sale và promo
			if ("DELIVERRED".equalsIgnoreCase(status) || "COMPLETED".equalsIgnoreCase(status)) {

			}
			ObjectNode successResp = mapper.createObjectNode();
			successResp.put("status", "success");
			successResp.put("message", "Lấy webhook Shopee thành công!!");
			successResp.put("ordersn", orderSn);
			successResp.put("order_status", status);
			return Response.ok(successResp).build();

		} catch (Exception e) {
			LOGGER.severe("Webhook Shopee error: " + e.getMessage());
			ObjectNode err = mapper.createObjectNode();
			err.put("error", e.getMessage());
			return Response.status(500).entity(err).build();
		}
	}

	private Invoice createSaleInvoiceFromEcomOrder(EcomOrder ecomOrder) {
		Invoice invoice = new Invoice();
		try {
			// Ánh xạ các trường từ EcomOrder sang Invoice
			invoice.setOrder_code(ecomOrder.getOrderId());
			invoice.setOrder_voucher(ecomOrder.getOrderNumber());
			invoice.setCustomer(ecomOrder.getCustomer());
			invoice.setPayment_method(ecomOrder.getPayment_method());
			invoice.setInvoice_date(new Date());
			invoice.setCreated_date(new Date());
			invoice.setCreated_by("SYSTEM");
			invoice.setRefId(UUID.randomUUID().toString());
			invoice.setEditVersion(0);
			invoice.setStatus(1); // Hoàn thành
			invoice.setDonvitien("VND");
			invoice.setNote(ecomOrder.getGhichu() != null ? ecomOrder.getGhichu() : "");
			invoice.setJsonhoadon(ecomOrder.getJsonhoadon());

			// Tính tổng tiền và thuế
			double tongtien = ecomOrder.getLastPrice() != null ? ecomOrder.getLastPrice() : 0.0;
			double taxValue = 0.08; // Giả định thuế 10%
			double thue = tongtien * taxValue;
			invoice.setTongtien(tongtien);
			invoice.setTax_value(taxValue);
			invoice.setThue(thue);

			// Ánh xạ chi tiết đơn hàng (không bao gồm sản phẩm khuyến mãi)
			List<InvoiceDetail> invoiceDetails = new ArrayList<>();
			if (ecomOrder.getOrderDetails() != null) {
				for (EcomOrderDetail detail : ecomOrder.getOrderDetails()) {

					InvoiceDetail invoiceDetail = new InvoiceDetail();
					invoiceDetail.setInvoice(invoice);
					Product product = new Product();
					product = productService.selectByCode(detail.getSku());
					invoiceDetail.setProduct(product);
					invoiceDetail.setQuantity(detail.getQuantity());
					invoiceDetail.setUnit_price(detail.getUnitPrice());
					invoiceDetail.setTotal(detail.getSplitPrice());
					invoiceDetail.setRefDetailID(UUID.randomUUID().toString());
					invoiceDetails.add(invoiceDetail);

				}
			}
			if (invoiceDetails.isEmpty()) {
				LOGGER.warning("No non-promotion items found for sale invoice, orderSn: " + ecomOrder.getOrderId());
				return null;
			}
			invoice.setList_invoice_detail(invoiceDetails);

			// Các trường mặc định
			invoice.setIe_categories(ieCategoriesService.findByCode("DEFAULT"));
			invoice.setWarehouse(warehouseService.findByCode("DEFAULT"));
			invoice.setPayment(false);
			invoice.setDiscount(ecomOrder.getSellerDiscount() != null ? ecomOrder.getSellerDiscount() : 0.0);
			invoice.setChietkhau(ecomOrder.getComboDiscount() != null ? ecomOrder.getComboDiscount() : 0.0);

			return invoice;
		} catch (Exception e) {
			LOGGER.severe("Failed to create Sale Invoice from EcomOrder: " + ecomOrder.getOrderId() + ", error: "
					+ e.getMessage());
			return null;
		}
	}

	/**
	 * Tạo Invoice khuyến mãi/tặng từ EcomOrder
	 */
	private Invoice createPromotionInvoiceFromEcomOrder(EcomOrder ecomOrder) {
		// Kiểm tra nếu có chiết khấu hoặc sản phẩm khuyến mãi
		boolean hasDiscount = (ecomOrder.getShopeeDiscount() != null && ecomOrder.getShopeeDiscount() > 0)
				|| (ecomOrder.getSellerDiscount() != null && ecomOrder.getSellerDiscount() > 0)
				|| (ecomOrder.getComboDiscount() != null && ecomOrder.getComboDiscount() > 0);
		boolean hasPromotionItems = ecomOrder.getOrderDetails() != null
				&& ecomOrder.getOrderDetails().stream().anyMatch(d -> d.getIsPromotion() != null && d.getIsPromotion());

		if (!hasDiscount && !hasPromotionItems) {
			return null; // Không cần tạo hóa đơn khuyến mãi
		}

		Invoice invoice = new Invoice();
		try {
			// Ánh xạ cơ bản
			invoice.setOrder_code(ecomOrder.getOrderId());
			invoice.setOrder_voucher(ecomOrder.getOrderNumber() + "-KM"); // Phân biệt hóa đơn khuyến mãi
			invoice.setCustomer(ecomOrder.getCustomer());
			invoice.setPayment_method(ecomOrder.getPayment_method());
			invoice.setInvoice_date(new Date());
			invoice.setCreated_date(new Date());
			invoice.setCreated_by("SYSTEM");
			invoice.setRefId(UUID.randomUUID().toString());
			invoice.setEditVersion(0);
			invoice.setStatus(1); // Hoàn thành
			invoice.setDonvitien("VND");
			invoice.setNote("Hóa đơn khuyến mãi/tặng cho đơn hàng " + ecomOrder.getOrderId());
			invoice.setIpromotion(true); // Đánh dấu hóa đơn khuyến mãi

			// Hóa đơn khuyến mãi: thuế 0%
			invoice.setTax_value(0.0);
			invoice.setThue(0.0);
			double tongtien = 0.0; // Tổng tiền sẽ tính từ chi tiết hoặc chiết khấu

			// Ánh xạ chi tiết khuyến mãi
			List<InvoiceDetail> invoiceDetails = new ArrayList<>();
			if (hasPromotionItems) {
				for (EcomOrderDetail detail : ecomOrder.getOrderDetails()) {
					if (detail.getIsPromotion() != null && detail.getIsPromotion()) {
						InvoiceDetail invoiceDetail = new InvoiceDetail();
						invoiceDetail.setInvoice(invoice);
						invoiceDetail.setProduct(detail.getProduct());
						invoiceDetail.setQuantity(detail.getQuantity());
						invoiceDetail.setUnit_price(0.0); // Sản phẩm tặng, đơn giá = 0
						invoiceDetail.setTotal(0.0);
						invoiceDetail.setRefDetailID(UUID.randomUUID().toString());
						invoiceDetails.add(invoiceDetail);
					}
				}
			}

			// Thêm chi tiết cho chiết khấu (nếu có)
			if (hasDiscount) {
				double totalDiscount = (ecomOrder.getShopeeDiscount() != null ? ecomOrder.getShopeeDiscount() : 0.0)
						+ (ecomOrder.getSellerDiscount() != null ? ecomOrder.getSellerDiscount() : 0.0)
						+ (ecomOrder.getComboDiscount() != null ? ecomOrder.getComboDiscount() : 0.0);
				InvoiceDetail discountDetail = new InvoiceDetail();
				discountDetail.setInvoice(invoice);
				Product discountProduct = productService.findByCode("DISCOUNT"); // Giả định mã sản phẩm chiết khấu
				if (discountProduct == null) {
					discountProduct = new Product();
					discountProduct.setProduct_code("DISCOUNT");
					discountProduct.setProduct_name("Chiết khấu đơn hàng");
				}
				discountDetail.setProduct(discountProduct);
				discountDetail.setQuantity(1.0);
				discountDetail.setUnit_price(-totalDiscount); // Âm để thể hiện chiết khấu
				discountDetail.setTotal(-totalDiscount);
				discountDetail.setRefDetailID(UUID.randomUUID().toString());
				invoiceDetails.add(discountDetail);
				tongtien = -totalDiscount; // Tổng tiền âm cho chiết khấu
			}

			if (invoiceDetails.isEmpty()) {
				LOGGER.warning("No promotion items or discounts found for promotion invoice, orderSn: "
						+ ecomOrder.getOrderId());
				return null;
			}
			invoice.setList_invoice_detail(invoiceDetails);
			invoice.setTongtien(tongtien);

			// Các trường mặc định
			invoice.setIe_categories(ieCategoriesService.findByCode("KM")); // Mã khuyến mãi
			invoice.setWarehouse(warehouseService.findByCode("DEFAULT"));
			invoice.setPayment(false);

			return invoice;
		} catch (Exception e) {
			LOGGER.severe("Failed to create Promotion Invoice from EcomOrder: " + ecomOrder.getOrderId() + ", error: "
					+ e.getMessage());
			return null;
		}
	}

	public OrderDTO fetchOrder(String orderSn) throws Exception {
		if (orderSn == null || orderSn.trim().isEmpty()) {
			throw new IllegalArgumentException("orderSn cannot be null or empty");
		}

		String accessToken = shopeeTokenManager.getAccessToken();
		long timestamp = System.currentTimeMillis() / 1000L;
		String path = "/api/v2/order/get_order_detail";
		String baseString = PARTNER_ID + path + timestamp + accessToken + SHOP_ID;
		String sign = generateHmacSHA256(baseString, API_PARTNER_KEY);

		String url = BASE_URL + path + "?partner_id=" + PARTNER_ID + "&timestamp=" + timestamp + "&access_token="
				+ accessToken + "&shop_id=" + SHOP_ID + "&sign=" + sign + "&order_sn_list=" + orderSn
				+ "&response_optional_fields=buyer_user_id,buyer_username,recipient_address,item_list,order_status,create_time,update_time,total_amount,payment_method,shipping_carrier";

		int maxRetries = 5;
		long delayMillis = 5000;
		IOException lastException = null;

		for (int attempt = 1; attempt <= maxRetries; attempt++) {
			HttpURLConnection conn = null;
			try {
				conn = (HttpURLConnection) new URL(url).openConnection();
				conn.setRequestMethod("GET");
				conn.setConnectTimeout(30000);
				conn.setReadTimeout(10000);
				conn.setRequestProperty("Accept", "application/json");

				int responseCode = conn.getResponseCode();
				InputStream inputStream = (responseCode == 200) ? conn.getInputStream() : conn.getErrorStream();

				StringBuilder responseBuilder = new StringBuilder();
				try (BufferedReader in = new BufferedReader(new InputStreamReader(inputStream))) {
					String line;
					while ((line = in.readLine()) != null) {
						responseBuilder.append(line);
					}
				}

				String jsonResponse = responseBuilder.toString();
				LOGGER.info("API Response for orderSn " + orderSn + ": " + jsonResponse);

				if (responseCode != 200) {
					throw new IOException("HTTP error code: " + responseCode + ", Response: " + jsonResponse);
				}

				JsonNode root = mapper.readTree(jsonResponse);
				JsonNode orderList = root.path("response").path("order_list");

				if (orderList.isArray() && orderList.size() > 0) {
					JsonNode orderData = orderList.get(0);
					String responseOrderSn = orderData.path("order_sn").asText(null);
					LOGGER.info("Response order_sn: " + responseOrderSn);
					if (responseOrderSn == null || responseOrderSn.isEmpty()) {
						throw new RuntimeException("Order SN missing in response for order_sn: " + orderSn);
					}
					if (!orderSn.equals(responseOrderSn)) {
						throw new RuntimeException("Order SN from response (" + responseOrderSn
								+ ") does not match requested order SN (" + orderSn + ")");
					}
					return parseOrderDTO(orderData, orderSn, jsonResponse);
				} else {
					throw new RuntimeException("Không có đơn hàng nào trả về từ Shopee cho order_sn: " + orderSn);
				}

			} catch (IOException ex) {
				lastException = ex;
				LOGGER.warning("Attempt " + attempt + " failed for orderSn " + orderSn + ": " + ex.getMessage());
				if (attempt < maxRetries) {
					Thread.sleep(delayMillis);
				}
			} finally {
				if (conn != null) {
					conn.disconnect();
				}
			}
		}

		throw new IOException("Failed to fetch order details after " + maxRetries + " attempts.", lastException);
	}

	private void fetchEscrowDetails(OrderDTO dto, List<OrderDetailDTO> details) throws Exception {
		if (dto == null || dto.getOrderId() == null) {
			throw new IllegalArgumentException("OrderDTO or orderId cannot be null");
		}

		String orderSn = dto.getOrderId();
		String accessToken = shopeeTokenManager.getAccessToken();
		long timestamp = System.currentTimeMillis() / 1000L;
		String path = "/api/v2/payment/get_escrow_detail";
		String baseString = PARTNER_ID + path + timestamp + accessToken + SHOP_ID;
		String sign = generateHmacSHA256(baseString, API_PARTNER_KEY);

		String url = BASE_URL + path + "?partner_id=" + PARTNER_ID + "&timestamp=" + timestamp + "&access_token="
				+ accessToken + "&shop_id=" + SHOP_ID + "&sign=" + sign + "&order_sn=" + orderSn;

		System.out.println(url);

		int maxRetries = 5;
		long delayMillis = 5000;
		IOException lastException = null;

		for (int attempt = 1; attempt <= maxRetries; attempt++) {
			HttpURLConnection conn = null;
			try {
				conn = (HttpURLConnection) new URL(url).openConnection();
				conn.setRequestMethod("GET");
				conn.setConnectTimeout(30000);
				conn.setReadTimeout(10000);
				conn.setRequestProperty("Accept", "application/json");

				int responseCode = conn.getResponseCode();
				InputStream inputStream = (responseCode == 200) ? conn.getInputStream() : conn.getErrorStream();

				StringBuilder responseBuilder = new StringBuilder();
				try (BufferedReader in = new BufferedReader(new InputStreamReader(inputStream))) {
					String line;
					while ((line = in.readLine()) != null) {
						responseBuilder.append(line);
					}
				}

				String jsonResponse = responseBuilder.toString();
				LOGGER.info("Escrow API Response for orderSn " + orderSn + ": " + jsonResponse);

				if (responseCode != 200) {
					throw new IOException("HTTP error code: " + responseCode + ", Response: " + jsonResponse);
				}

				JsonNode root = mapper.readTree(jsonResponse);
				JsonNode orderIncome = root.path("response").path("order_income");
				JsonNode items = orderIncome.path("items");

				if (items.isArray() && items.size() > 0) {
					double totalShopeeDiscount = 0.0;
					double totalSellerDiscount = 0.0;
					double totalComboDiscount = 0.0;
					double discountPrice = 0.0;

					for (JsonNode item : items) {
						totalShopeeDiscount += item.path("shopee_discount").asDouble(0.0);
						totalSellerDiscount += item.path("discount_from_voucher_seller").asDouble(0.0);
						totalComboDiscount += (item.path("selling_price").asDouble(0.0)
								- item.path("discounted_price").asDouble(0.0));
						discountPrice += item.path("discounted_price").asDouble(0.0);

						String orderItemId = item.path("order_item_id").asText("");
						double discountedPrice = item.path("discounted_price").asDouble(0.0);
						for (OrderDetailDTO detail : details) {
							if (detail.getOrderItemId().equals(orderItemId)) {
								detail.setDiscountedPrice(discountedPrice);
							}
						}
					}

					double lastPrice = (discountPrice + totalShopeeDiscount - totalSellerDiscount) / (1.08);
					dto.setLastPrice(lastPrice);

					LOGGER.info("Escrow details parsed for orderSn: " + orderSn + ", Shopee discount: "
							+ totalShopeeDiscount + ", Seller discount: " + totalSellerDiscount + ", Combo discount: "
							+ totalComboDiscount + ", Last price: " + lastPrice);
				} else {
					LOGGER.warning("No items found in escrow details for orderSn: " + orderSn);
					dto.setShopeeDiscount(0.0);
					dto.setSellerDiscount(0.0);
					dto.setComboDiscount(0.0);
					dto.setLastPrice(dto.getPrice() != null ? dto.getPrice() : 0.0);
				}

				return;

			} catch (IOException ex) {
				lastException = ex;
				LOGGER.warning("Attempt " + attempt + " failed for escrow details of orderSn " + orderSn + ": "
						+ ex.getMessage());
				if (attempt < maxRetries) {
					Thread.sleep(delayMillis);
				}
			} finally {
				if (conn != null) {
					conn.disconnect();
				}
			}
		}

		if (lastException != null) {
			throw new IOException("Failed to fetch escrow details after " + maxRetries + " attempts.", lastException);
		}
	}

	private OrderDTO parseOrderDTO(JsonNode data, String orderSn, String jsonResponse) throws Exception {
		OrderDTO saleDTO = new OrderDTO();
		saleDTO.setOrderId(orderSn);
		LOGGER.info("Setting orderId in OrderDTO: " + orderSn);

		// Thông tin chung
		saleDTO.setOrder_status(data.path("order_status").asText());
		saleDTO.setCreatedAt(new Date(data.path("create_time").asLong(0) * 1000));
		saleDTO.setUpdatedAt(new Date(data.path("update_time").asLong(0) * 1000));
		saleDTO.setPrice(data.path("total_amount").asDouble(0.0));
		saleDTO.seteCommerceType("Shopee");
		saleDTO.setOrderType("SALE");
		saleDTO.setCustomerFirstName(data.path("recipient_address").path("name").asText(""));
		saleDTO.setCustomerLastName("");
		saleDTO.setDataJson(jsonResponse);
		List<OrderDetailDTO> saleDetails = new ArrayList<>();
		List<OrderDetailDTO> promoDetails = new ArrayList<>();
		JsonNode itemList = data.path("item_list");
		int index = 1;

		for (JsonNode item : itemList) {
			double apiItemPrice = item.path("model_discounted_price").asDouble(0.0);
			String itemName = item.path("item_name").asText("");
			String modelName = item.path("model_name").asText("");
			if (!modelName.isEmpty()) {
				itemName += " (" + modelName + ")";
			}

			boolean isPromoByPrice = apiItemPrice == 0.0;

			OrderDetailDTO detail = new OrderDetailDTO();
			detail.setOrderItemId(item.path("order_item_id").asText(""));
			detail.setName(itemName);
			String sku = item.path("model_sku").asText();
			if (sku == null || sku.trim().isEmpty()) {
				sku = item.path("item_sku").asText("");
			}
			detail.setSku(sku);
			detail.setStt(index++);
			detail.setQuantity(item.path("model_quantity_purchased").asInt(0));
			detail.setOrderId(orderSn);
			boolean isVariant = !item.path("main_item").asBoolean(true) && !item.path("model_sku").asText("").isEmpty();
			detail.setVariant(isVariant);
			detail.setLoaitmdt("Shopee");
			detail.setPromotionType(item.path("promotion_type").asText(""));

			// Tạm thời set itemPrice từ API
			detail.setItemPrice(apiItemPrice);

			// Xác định loại chi tiết
			boolean isBundleDeal = itemName.toUpperCase().contains("MUA 2 GIẢM 50%");
			boolean isPromo = (apiItemPrice == 0.0) || isPromoByPrice;
			detail.setOrderDetailType(isPromo ? "PROMO" : "SALE");

			if (isBundleDeal) {
				saleDetails.add(detail);
				break;

			} else if (isPromo) {
				detail.setLastItemPrice(0.0);
				detail.setUnitPrice(0.0);
				promoDetails.add(detail);
				break;
			} else {
				saleDetails.add(detail);
			}
		}
		// Lấy escrow details (gán discountedPrice cho từng detail và tổng
		// discountedPrice cho dto)
		fetchEscrowDetails(saleDTO, saleDetails);
		// Tách SKU cho saleDetails
		List<OrderDetailDTO> allSaleSplitDetails = new ArrayList<>();
		for (OrderDetailDTO detail : saleDetails) {
			List<OrderDetailDTO> splitDetails = splitSku(detail);
			allSaleSplitDetails.addAll(splitDetails);
		}

		saleDTO.setOrderDetails(allSaleSplitDetails);

		// Sau khi có escrow, override itemPrice cho bundle deal = discountedPrice từ
		// escrow
		for (OrderDetailDTO detail : saleDTO.getOrderDetails()) {
			if (detail.getName() != null && detail.getName().toUpperCase().contains("MUA 2 GIẢM 50%")) {
				Double escrowDiscounted = detail.getDiscountedPrice();
				if (escrowDiscounted != null && escrowDiscounted > 0) {
					detail.setItemPrice(escrowDiscounted);
				} else {
					detail.setItemPrice(0.0);
				}
			}
		}

		// Phân bổ lastPrice cho saleDetails
		double totalLastPrice = saleDTO.getLastPrice() != null ? saleDTO.getLastPrice() : 0.0;
		if (!allSaleSplitDetails.isEmpty() && totalLastPrice > 0) {
			List<OrderDetailDTO> validDetails = allSaleSplitDetails.stream().filter(detail -> detail.getItemPrice() > 0)
					.collect(Collectors.toList());

			if (!validDetails.isEmpty()) {
				double[] itemPricesArray = validDetails.stream().mapToDouble(OrderDetailDTO::getItemPrice).toArray();
				double[] ratios = calculateAllocationRatios(itemPricesArray);

				for (int i = 0; i < validDetails.size(); i++) {
					OrderDetailDTO detail = validDetails.get(i);
					double allocatedPrice = ratios[i] * totalLastPrice;
					detail.setLastItemPrice(allocatedPrice);
					if (detail.getQuantity() > 0) {
						detail.setUnitPrice(allocatedPrice / detail.getQuantity());
					} else {
						detail.setUnitPrice(0.0);
					}
				}
			}

			// Những detail không hợp lệ sẽ có giá 0
			for (OrderDetailDTO detail : allSaleSplitDetails) {
				if (detail.getItemPrice() <= 0) {
					detail.setLastItemPrice(0.0);
					detail.setUnitPrice(0.0);
				}
			}
		}

		// Xử lý promoDetails thành promoDTO riêng
		OrderDTO promoDTO = null;
		if (!promoDetails.isEmpty()) {
			promoDTO = new OrderDTO();
			promoDTO.setOrderId(orderSn);
			promoDTO.setOrder_status(data.path("order_status").asText());
			promoDTO.setCreatedAt(new Date(data.path("create_time").asLong(0) * 1000));
			promoDTO.setUpdatedAt(new Date(data.path("update_time").asLong(0) * 1000));
			promoDTO.setPrice(0.0);
			promoDTO.seteCommerceType("Shopee");
			promoDTO.setOrderType("PROMO");
			promoDTO.setCustomerFirstName(data.path("recipient_address").path("name").asText(""));
			promoDTO.setCustomerLastName("");
			promoDTO.setOrderDetails(promoDetails);
			promoDTO.setLastPrice(0.0);
			promoDTO.setShopeeDiscount(0.0);
			promoDTO.setSellerDiscount(0.0);
			promoDTO.setComboDiscount(0.0);
			promoDTO.setDiscountedPrice(0.0);
			promoDTO.setDataJson(jsonResponse);
		}

		// Lưu order
		saveOrUpdateOrder(saleDTO);
		if (promoDTO != null) {
			saveOrUpdateOrder(promoDTO);
		}

		return saleDTO;
	}

	public void saveOrUpdateOrder(OrderDTO dto) {
		String orderNumber = dto.getOrderId();
		String platform = dto.geteCommerceType();
		String orderType = dto.getOrderType();
		String dataJSON = dto.getDataJson();
		// Tìm EcomOrder theo orderNumber, platform và orderType
		EcomOrder existing = ecomOrderService.findByCodeAndPlatformAndOrderType(orderNumber, platform, orderType);
		EcomOrder order;

		if (existing == null) {
			order = new EcomOrder();
			order.setOrderNumber(orderNumber);
			order.setOrderType(orderType);
			order.setCustomerFirstName(dto.getCustomerFirstName());
			order.setCustomerLastName(dto.getCustomerLastName());
			order.setCreatedAt(dto.getCreatedAt());
			order.setLoaitmdt(platform);
			if (dataJSON != null) {
				order.setDataJson(dataJSON);
			} else {
				LOGGER.severe("Không thể lưu JSON:" + dataJSON);
			}
			LOGGER.info("Creating new Shopee order: " + orderNumber + " (Type: " + orderType + ")");
		} else {
			order = existing;
			LOGGER.info("Updating existing Shopee order: " + orderNumber + " (Type: " + orderType + ")");
		}

		order.setUpdatedAt(dto.getUpdatedAt());
		order.setPrice(dto.getPrice());
		order.setStatus(dto.getOrder_status());
		order.setThoigiancapnhat(new Date());
		order.setComboDiscount(dto.getComboDiscount());
		order.setShopeeDiscount(dto.getShopeeDiscount());
		order.setSellerDiscount(dto.getSellerDiscount());
		order.setDiscountedPrice(dto.getDiscountedPrice());
		order.setLastPrice(dto.getLastPrice());
		EcomOrderUtils.setMyStatus(order);
		Customer customer = customerService.selectByCode("OL248");
		order.setCustomer(customer);

		if (existing == null) {
			ecomOrderService.create(order);
		}
		List<EcomOrderDetail> newDetails = new ArrayList<>();
		List<EcomOrderDetail> oldDetails = ecomOrderDetailService.findByCodeAndPlatform(orderNumber, platform);
		for (EcomOrderDetail old : oldDetails) {
			ecomOrderDetailService.delete(old);
		}

		// Lưu chi tiết mới
		for (OrderDetailDTO splitDetail : dto.getOrderDetails()) {

			EcomOrderDetail orddetail = new EcomOrderDetail();
			orddetail.setOrder(order);
			orddetail.setOrderItemNumber(splitDetail.getOrderItemId());
			orddetail.setName(splitDetail.getName());
			orddetail.setSku(splitDetail.getSku());
			orddetail.setLoaitmdt(platform);
			orddetail.setVariant(splitDetail.isVariant());
			orddetail.setQuantity(splitDetail.getQuantity());
			orddetail.setItemPrice(splitDetail.getItemPrice());
			orddetail.setSplitPrice(splitDetail.getLastItemPrice());
			orddetail.setUnitPrice(splitDetail.getUnitPrice());
			orddetail.setOrderId(orderNumber);
			orddetail.setOrderType(splitDetail.getOrderDetailType());
			ecomOrderDetailService.create(orddetail);
			newDetails.add(orddetail);
			LOGGER.info("Saved detail: orderType=" + splitDetail.getOrderDetailType() + ", sku=" + splitDetail.getSku()
					+ ", itemPrice=" + splitDetail.getItemPrice() + ", lastItemPrice=" + splitDetail.getLastItemPrice()
					+ ", unitPrice=" + splitDetail.getUnitPrice() + ", quantity=" + splitDetail.getQuantity());
		}
		order.setOrderDetails(newDetails);
		ecomOrderService.update(order);
	}

	@Inject
	private ICustomerPricingProgramService customerPricingProgramService;

	@Inject
	private IProductService productService;

	@Inject
	private IPricingProgramService priceProgramService;

	@Inject
	private ICustomerService customerService;

	@Inject
	private IPricingProgramDetailService pricingProgramDetailService;

	private List<OrderDetailDTO> splitSku(OrderDetailDTO detail) {
		if (customerService == null) {
			List<OrderDetailDTO> result = new ArrayList<>();
			result.add(detail);
			return result;
		}

		Customer customer = null;
		try {
			customer = customerService.selectByCode("CO648");
		} catch (Exception e) {
			LOGGER.warning("Error fetching customer CO648: " + e.getMessage());
			List<OrderDetailDTO> result = new ArrayList<>();
			result.add(detail);
			return result;
		}
		if (customer == null) {
			LOGGER.warning("Không thấy mã KH CO648");
			List<OrderDetailDTO> result = new ArrayList<>();
			result.add(detail);
			return result;
		}

		PricingProgram pricingProgram = priceProgramService.findByCode("DG027968");
		if (pricingProgram == null) {
			LOGGER.warning("Pricing program DG027968 not found");
			List<OrderDetailDTO> result = new ArrayList<>();
			result.add(detail);
			return result;
		}

		List<PricingProgramDetail> pricingProgramDetails = pricingProgramDetailService
				.findAllByPricingProgram(pricingProgram.getId());

		List<OrderDetailDTO> result = new ArrayList<>();
		String skuString = detail.getSku();

		if (skuString == null || skuString.trim().isEmpty()) {
			result.add(detail);
			return result;
		}

		skuString = skuString.trim();
		int originalQuantity = detail.getQuantity(); // model_quantity_purchased

		Pattern pattern = Pattern.compile("^(\\d+)C\\s*(?:\\+|\\-)\\s*(.+)$");
		Matcher matcher = pattern.matcher(skuString);

		if (matcher.matches()) {
			int prefixNumber = Integer.parseInt(matcher.group(1));
			String remainingSku = matcher.group(2).trim();
			String[] skuParts = remainingSku.split("\\s*\\+\\s*");

			if (skuParts.length >= 1) {
				if (skuParts.length == 1) {
					// Trường hợp 2C-A hoặc 3C-A
					OrderDetailDTO newDetail = createDetailWithPricing(detail, skuParts[0].trim(),
							prefixNumber * originalQuantity, pricingProgramDetails);
					result.add(newDetail);
				} else if (skuParts.length == 2) {
					// Trường hợp 2C-A+B hoặc 3C-A+B
					OrderDetailDTO detailA = createDetailWithPricing(detail, skuParts[0].trim(),
							prefixNumber * originalQuantity, pricingProgramDetails);
					OrderDetailDTO detailB = createDetailWithPricing(detail, skuParts[1].trim(), 1 * originalQuantity,
							pricingProgramDetails);
					result.add(detailA);
					result.add(detailB);
				} else if (skuParts.length >= 3) {
					// Trường hợp 2C-A+B+C hoặc 3C-A+B+C
					OrderDetailDTO detailA = createDetailWithPricing(detail, skuParts[0].trim(),
							prefixNumber * originalQuantity, pricingProgramDetails);
					result.add(detailA);
					for (int i = 1; i < skuParts.length; i++) {
						OrderDetailDTO newDetail = createDetailWithPricing(detail, skuParts[i].trim(),
								1 * originalQuantity, pricingProgramDetails);
						result.add(newDetail);
					}
				}
			}
		} else {
			String[] skuParts = skuString.split("\\s*\\+\\s*");
			if (skuParts.length > 1) {
				if (skuParts.length == 2) {
					// Trường hợp A+B (ví dụ: Z1402+QTMEN)
					OrderDetailDTO detailA = createDetailWithPricing(detail, skuParts[0].trim(), 1 * originalQuantity,
							pricingProgramDetails);
					OrderDetailDTO detailB = createDetailWithPricing(detail, skuParts[1].trim(), 1 * originalQuantity,
							pricingProgramDetails);
					result.add(detailA);
					result.add(detailB);
				} else {
					// Trường hợp A+B+C (3 phần tử trở lên)
					for (String part : skuParts) {
						if (!part.trim().isEmpty()) {
							OrderDetailDTO newDetail = createDetailWithPricing(detail, part.trim(),
									1 * originalQuantity, pricingProgramDetails);
							result.add(newDetail);
						}
					}
				}
			} else {
				// Trường hợp SKU đơn
				OrderDetailDTO newDetail = createDetailWithPricing(detail, skuString, originalQuantity,
						pricingProgramDetails);
				result.add(newDetail);
			}
		}

		return result;
	}

	private OrderDetailDTO createDetailWithPricing(OrderDetailDTO originalDetail, String sku, int quantity,
			List<PricingProgramDetail> pricingDetails) {
		if (productService == null) {
			LOGGER.severe("productService is null, injection failed");
			return new OrderDetailDTO();
		}

		OrderDetailDTO newDetail = new OrderDetailDTO();
		newDetail.setOrderItemId(originalDetail.getOrderItemId());
		newDetail.setSku(sku);
		newDetail.setStt(originalDetail.getStt());
		newDetail.setQuantity(quantity);
		newDetail.setOrderId(originalDetail.getOrderId());
		newDetail.setVariant(originalDetail.isVariant());
		newDetail.setLoaitmdt(originalDetail.getLoaitmdt());
		newDetail.setPromotionType(originalDetail.getPromotionType()); // Truyền promotion_type
		newDetail.setDiscountedPrice(originalDetail.getDiscountedPrice()); // Truyền discounted_price

		// Kiểm tra SKU có chứa "QT" để xác định PROMO hay SALE
		boolean isPromo = sku.toUpperCase().contains("QT");
		newDetail.setOrderDetailType(isPromo ? "PROMO" : "SALE");

		// Lấy tên từ productService
		Product product = productService.selectByCode(sku);
		if (product != null && product.getProduct_name() != null) {
			newDetail.setName(product.getProduct_name());
		} else {
			LOGGER.warning("Không tìm thấy sản phẩm: " + sku + ", trong chương trình TTSP");
			newDetail.setName(originalDetail.getName());
		}

		// Tìm itemPrice dựa trên promotion_type
		double itemPrice;
//		if ("bundle_deal".equalsIgnoreCase(newDetail.getPromotionType())) {
//			itemPrice = newDetail.getDiscountedPrice() > 0 ? newDetail.getDiscountedPrice() : 0.0;
//		} else {
		itemPrice = findItemPriceForSku(sku, pricingDetails);
//		}
		newDetail.setItemPrice(itemPrice);

		newDetail.setLastItemPrice(isPromo ? 0.0 : 0.0); // lastItemPrice sẽ được set sau trong parseOrderDTO
		newDetail.setUnitPrice(isPromo ? 0.0 : 0.0); // unitPrice sẽ được set sau trong parseOrderDTO

		LOGGER.info("Created detail: sku=" + sku + ", name=" + newDetail.getName() + ", itemPrice=" + itemPrice
				+ ", quantity=" + quantity + ", orderDetailType=" + newDetail.getOrderDetailType() + ", promotionType="
				+ newDetail.getPromotionType());
		return newDetail;
	}

	private double findItemPriceForSku(String sku, List<PricingProgramDetail> pricingDetails) {
		Product product = productService.selectByCode(sku);
		if (product == null || product.getProduct_code() == null) {
			LOGGER.warning("Product not found for SKU: " + sku);
			return 0.0;
		}

		return pricingDetails.stream().filter(item -> item.getProduct() != null)
				.filter(item -> product.getProduct_code().equals(item.getProduct().getProduct_code()))
				.mapToDouble(item -> item.getUnit_price()).findFirst().orElse(0.0);
	}

	/**
	 * Tính toán tỷ lệ phân bổ dựa trên đơn giá với trọng số ưu tiên cho giá cao hơn
	 * 
	 * @param itemPrices Danh sách đơn giá các SKU
	 * @return Mảng tỷ lệ phân bổ tương ứng
	 */
	private double[] calculateAllocationRatios(double[] itemPrices) {
		double totalPrice = Arrays.stream(itemPrices).sum();
		double[] ratios = new double[itemPrices.length];

		if (totalPrice <= 0) {
			// Nếu tất cả đơn giá = 0, chia đều
			Arrays.fill(ratios, 1.0 / itemPrices.length);
			return ratios;
		}

		// Tìm giá cao nhất để làm chuẩn
		double maxPrice = Arrays.stream(itemPrices).max().orElse(1.0);

		// Tính tỷ lệ cơ bản và áp dụng trọng số
		double totalWeightedRatio = 0.0;
		for (int i = 0; i < itemPrices.length; i++) {
			double baseRatio = itemPrices[i] / totalPrice;
			// Tăng trọng số cho SKU có giá cao (hệ số 0.4 để tăng tối đa 40%)
			double weightFactor = 0.4 * (itemPrices[i] / maxPrice);
			ratios[i] = baseRatio + (baseRatio * weightFactor);
			totalWeightedRatio += ratios[i];
		}

		// Chuẩn hóa để tổng = 1.0
		for (int i = 0; i < ratios.length; i++) {
			ratios[i] = ratios[i] / totalWeightedRatio;
			// Đảm bảo không vượt quá 80% cho bất kỳ SKU nào
			ratios[i] = Math.min(0.8, ratios[i]);
		}

		// Điều chỉnh lại để tổng = 1.0 sau khi giới hạn 80%
		double actualTotal = Arrays.stream(ratios).sum();
		if (actualTotal > 0) {
			for (int i = 0; i < ratios.length; i++) {
				ratios[i] = ratios[i] / actualTotal;
			}
		}

		return ratios;
	}

	private String generateHmacSHA256(String data, String key) throws Exception {
		Mac mac = Mac.getInstance("HmacSHA256");
		SecretKeySpec secretKey = new SecretKeySpec(key.getBytes(StandardCharsets.UTF_8), "HmacSHA256");
		mac.init(secretKey);
		byte[] hashBytes = mac.doFinal(data.getBytes(StandardCharsets.UTF_8));
		StringBuilder sb = new StringBuilder();
		for (byte b : hashBytes) {
			sb.append(String.format("%02x", b));
		}
		return sb.toString();
	}

	private static ShopeeAPIServlet instance = new ShopeeAPIServlet();

	public static ShopeeAPIServlet getInstance() {
		return instance;
	}

	public void setShopeeTokenManager(ShopeeTokenManager manager) {
		this.shopeeTokenManager = manager;
	}
}