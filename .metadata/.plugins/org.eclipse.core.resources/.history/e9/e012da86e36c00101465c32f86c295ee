package lixco.com.bean;

import lombok.Getter;
import lombok.Setter;
import trong.lixco.com.bean.AbstractBean;
import vinh.lixco.com.apiecommerce.LazadaAPIServlet;
import vinh.lixco.com.apiecommerce.OrderDTO;

import javax.faces.application.FacesMessage;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.ViewScoped;
import javax.faces.context.FacesContext;
import java.io.IOException;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.logging.Logger;

@ManagedBean
@ViewScoped
public class EcomOrderBean extends AbstractBean implements Serializable {
    private static final long serialVersionUID = 1L;
    private static final Logger LOGGER = Logger.getLogger(EcomOrderBean.class.getName());

    @Getter
    @Setter
    private List<OrderDTO> orders = new ArrayList<>();
    @Getter
    @Setter
    private OrderDTO order;

    @Override
    protected void initItem() {
        orders = new ArrayList<>();
        order = new OrderDTO();
        order.setOrderDetails(new ArrayList<>());

        LazadaAPIServlet lazadaService = LazadaAPIServlet.getInstance();
		Map<String, OrderDTO> pendingUpdates = LazadaAPIServlet.getPendingUpdates();
		synchronized (pendingUpdates) {
		    orders.addAll(pendingUpdates.values());
		    LOGGER.info("Đã khởi tạo danh sách đơn hàng từ pendingUpdates, tổng số: " + orders.size());
		    for (OrderDTO orderDTO : orders) {
		    	try {
		    	    OrderDTO updatedOrder = lazadaService.fetchOrderData(orderDTO.getOrderId());
		    	    if (updatedOrder != null) {
		    	        updateOrderInList(updatedOrder);
		    	    }
		    	} catch (Exception e) {
		    	    LOGGER.severe("Lỗi khi lấy đơn hàng " + orderDTO.getOrderId() + ": " + e.getMessage());
		    	}

		    }
		}
    }

    @Override
    protected org.jboss.logging.Logger getLogger() {
        return org.jboss.logging.Logger.getLogger(EcomOrderBean.class);
    }

    public void updateOrderStatus() {
        LazadaAPIServlet lazadaService = LazadaAPIServlet.getInstance();
        synchronized (orders) {
            Map<String, OrderDTO> updates = LazadaAPIServlet.getPendingUpdates();
            for (OrderDTO dto : orders) {
                OrderDTO update = updates.get(dto.getOrderId());
                if (update != null) {
                    dto.setOrder_status(update.getOrder_status());
                    dto.setCustomerLastName(update.getCustomerLastName());
                    dto.setCustomerFirstName(update.getCustomerFirstName());
                    dto.setCreatedAt(update.getCreatedAt());
                    dto.setUpdatedAt(update.getUpdatedAt());
                    dto.setShippingFee(update.getShippingFee());
                    dto.setOrderDetails(update.getOrderDetails());
                }
            }
        }
    }

    public void refreshOrders() {
        LazadaAPIServlet lazadaService = LazadaAPIServlet.getInstance();
        try {
            updateOrderStatus();
            Map<String, OrderDTO> pendingUpdates = LazadaAPIServlet.getPendingUpdates();
            synchronized (orders) {
                for (OrderDTO existingOrder : orders) {
                	try {
    		    	    OrderDTO updatedOrder = lazadaService.fetchOrderData(existingOrder.getOrderId());
    		    	    if (updatedOrder != null) {
    		    	        updateOrderInList(updatedOrder);
    		    	    }
    		    	} catch (Exception e) {
    		    	    LOGGER.severe("Lỗi khi lấy đơn hàng " + existingOrder.getOrderId() + ": " + e.getMessage());
    		    	}
                }
                synchronized (pendingUpdates) {
                    for (OrderDTO newOrder : pendingUpdates.values()) {
                        if (orders.stream().noneMatch(o -> o.getOrderId().equals(newOrder.getOrderId()))) {
                           	try {
            		    	    OrderDTO updatedOrder = lazadaService.fetchOrderData(newOrder.getOrderId());
            		    	    if (updatedOrder != null) {
            		    	        updateOrderInList(updatedOrder);
            		    	    }
            		    	} catch (Exception e) {
            		    	    LOGGER.severe("Lỗi khi lấy đơn hàng " + newOrder.getOrderId() + ": " + e.getMessage());
            		    	}
                        }
                    }
                }
            }
            LOGGER.info("Đã làm mới danh sách đơn hàng, tổng số: " + orders.size());
            FacesContext.getCurrentInstance().addMessage(null,
                    new FacesMessage(FacesMessage.SEVERITY_INFO, "Thành công", "Đã làm mới danh sách đơn hàng"));
        } catch (IOException e) {
            LOGGER.severe("Lỗi khi làm mới danh sách đơn hàng: " + e.getMessage());
            FacesContext.getCurrentInstance().addMessage(null,
                    new FacesMessage(FacesMessage.SEVERITY_ERROR, "Lỗi", "Không thể làm mới danh sách đơn hàng: " + e.getMessage()));
        }
    }

    private void updateOrderInList(OrderDTO updatedOrder) {
        synchronized (orders) {
            for (int i = 0; i < orders.size(); i++) {
                OrderDTO existingOrder = orders.get(i);
                if (existingOrder.getOrderId().equals(updatedOrder.getOrderId())) {
                    orders.set(i, updatedOrder);
                    LOGGER.info("Cập nhật đơn hàng " + updatedOrder.getOrderId());
                    return;
                }
            }
            orders.add(updatedOrder);
            LOGGER.info("Thêm đơn hàng mới " + updatedOrder.getOrderId());
        }
    }
}
