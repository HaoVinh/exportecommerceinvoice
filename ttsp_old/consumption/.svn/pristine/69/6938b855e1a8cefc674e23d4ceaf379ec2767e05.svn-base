package lixco.com.bean_report;

import java.util.ArrayList;
import java.util.Base64;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;

import javax.faces.context.FacesContext;
import javax.inject.Inject;
import javax.inject.Named;

import lixco.com.commom_ejb.MyMath;
import lixco.com.common.FormatHandler;
import lixco.com.common.JsonParserUtil;
import lixco.com.common.ToolTimeCustomer;
import lixco.com.entity.Product;
import lixco.com.entity.ProductType;
import lixco.com.interfaces.IProductService;
import lixco.com.interfaces.IProductTypeService;
import lixco.com.interfaces.IReportService;
import lixco.com.reportInfo.TonKhoSanPham;
import net.sf.jasperreports.engine.JREmptyDataSource;
import net.sf.jasperreports.engine.JRParameter;
import net.sf.jasperreports.engine.JasperExportManager;
import net.sf.jasperreports.engine.JasperFillManager;
import net.sf.jasperreports.engine.JasperPrint;

import org.jboss.logging.Logger;
import org.omnifaces.cdi.ViewScoped;
import org.primefaces.PrimeFaces;

import trong.lixco.com.bean.AbstractBean;
import trong.lixco.com.util.Notify;
import trong.lixco.com.util.ToolReport;

import com.google.gson.JsonObject;

@Named
@ViewScoped
public class ReportTonKhoSanPhamBean extends AbstractBean {
	private static final long serialVersionUID = -8870786800128625218L;
	@Inject
	private Logger logger;
	@Inject
	private IReportService reportService;
	@Inject
	private IProductService productService;
	@Inject
	private IProductTypeService productTypeService;
	private Date fromDateSearch;
	private Date toDateSearch;
	private Product productSearch;
	private ProductType productTypeSearch;
	private List<ProductType> listProductType;
	private int typep = -1;
	private List<TonKhoSanPham> listTonKhoSanPham;
	private List<TonKhoSanPham> listTonKhoSanPhamFilter;
	private FormatHandler formatHandler;

	@Override
	protected void initItem() {
		try {
			listProductType = new ArrayList<>();
			productTypeService.selectAll(listProductType);
			int month = ToolTimeCustomer.getMonthCurrent();
			int year = ToolTimeCustomer.getYearCurrent();
			fromDateSearch = ToolTimeCustomer.getDateMinCustomer(month, year);
			toDateSearch = ToolTimeCustomer.getDateMaxCustomer(month, year);
			formatHandler = FormatHandler.getInstance();
		} catch (Exception e) {
			logger.error("ReportTonKhoSanPhamBean.initItem:" + e.getMessage(), e);
		}
	}

	public List<Product> completeProduct(String text) {
		try {
			List<Product> list = new ArrayList<>();
			productService.complete(FormatHandler.getInstance().converViToEn(text), list);
			return list;
		} catch (Exception e) {
			logger.error("ReportTonKhoThangBean.completeProduct:" + e.getMessage(), e);
		}
		return null;
	}

	public void search() {
		Notify notify = new Notify(FacesContext.getCurrentInstance());
		PrimeFaces current = PrimeFaces.current();
		try {
			proccessTonKho();
			if (listTonKhoSanPham.size() == 0) {
				notify.warning("Không có dữ liệu!");
			}
		} catch (Exception e) {
			logger.error("ReportTonKhoSanPhamBean.search:" + e.getMessage(), e);
		}
		current.executeScript("PF('tablenc').clearFilters();");
	}

	public void proccessTonKho() {
		JsonObject json = new JsonObject();
		json.addProperty("from_date", ToolTimeCustomer.convertDateToString(fromDateSearch, "dd/MM/yyyy"));
		json.addProperty("to_date", ToolTimeCustomer.convertDateToString(toDateSearch, "dd/MM/yyyy"));
		json.addProperty("product_id", productSearch == null ? 0 : productSearch.getId());
		json.addProperty("product_type_id", productTypeSearch == null ? 0 : productTypeSearch.getId());
		json.addProperty("typep", typep);
		listTonKhoSanPham = new ArrayList<TonKhoSanPham>();
		reportService.reportTonKhoSanPham(JsonParserUtil.getGson().toJson(json), listTonKhoSanPham);
//		if (listTonKhoSanPham.size() > 0) {
//			LocalDate lc = new LocalDate(toDateSearch);
//			LocalDate lcSau = lc.plusDays(1);
//			if (lc.getMonthOfYear() != lcSau.getMonthOfYear()) {
//				for (int i = 0; i < listTonKhoSanPham.size(); i++) {
//					TonKhoDauThang tk = reportService.reportTonKhoDauThang(lc.getMonthOfYear(), lc.getYear(),
//							listTonKhoSanPham.get(i).getProduct_id());
//					if (tk != null) {
//						double tonconlai = tk.getKg_inv_balance() - listTonKhoSanPham.get(i).getKg_closing_balance();
//						listTonKhoSanPham.get(i).setKg_export_quantity(
//								listTonKhoSanPham.get(i).getKg_export_quantity() - tonconlai);
//						listTonKhoSanPham.get(i).setKg_closing_balance(tk.getKg_inv_balance());
//
//					}
//				}
//			}
//		}
	}

	public void reportTonKhoSanPham() {
		PrimeFaces current = PrimeFaces.current();
		Notify notify = new Notify(FacesContext.getCurrentInstance());
		try {
			proccessTonKho();
			if (listTonKhoSanPham.size() > 0) {
				String reportPath = FacesContext.getCurrentInstance().getExternalContext()
						.getRealPath("/resources/reports/reportinsanpham/ton_san_pham/ton_san_pham.jasper");
				Map<String, Object> importParam = new HashMap<String, Object>();
				Locale locale = new Locale("vi", "VI");
				importParam.put(JRParameter.REPORT_LOCALE, locale);
				importParam.put(
						"logo",
						FacesContext.getCurrentInstance().getExternalContext()
								.getRealPath("/resources/gfx/lixco_logo.png"));
				StringBuilder title = new StringBuilder();
				title.append("TỒN KHO SẢN PHẨM TỪ NGÀY "
						+ ToolTimeCustomer.convertDateToString(fromDateSearch, "dd/MM/yyyy"));
				title.append(" ĐẾN NGÀY " + ToolTimeCustomer.convertDateToString(toDateSearch, "dd/MM/yyyy"));
				importParam.put("title", title.toString());
				importParam.put("list_data", listTonKhoSanPham);
				JasperPrint jasperPrint = JasperFillManager
						.fillReport(reportPath, importParam, new JREmptyDataSource());
				byte[] data = JasperExportManager.exportReportToPdf(jasperPrint);
				String ba = Base64.getEncoder().encodeToString(data);
				current.executeScript("PF('showImg').show();");
				current.executeScript("utility.showPDFK('" + ba + "','')");
			} else {
				notify.warning("Không có dữ liệu");
			}
		} catch (Exception e) {
			logger.error("ReportTonKhoSanPhamBean.reportTonKhoSanPham:" + e.getMessage(), e);
		}
	}

	public void reportTonKhoSanPhamExcel() {
		Notify notify = new Notify(FacesContext.getCurrentInstance());
		try {
			proccessTonKho();
			if (listTonKhoSanPham.size() > 0) {
				List<Object[]> results = new ArrayList<Object[]>();
				Object[] title = { "MÃ LOẠI SP", "TÊN LOẠI SP", "MÃ SP BRAND", "TÊN SP BRAND", "LEVER CODE", "MASP",
						"SẢN PHẨM", "TỒN ĐẦU(Kg)", "TỒN ĐẦU(ĐVT)", "NHẬP(Kg)", "NHẬP(ĐVT)", "SL.XUẤT(Kg)",
						"SL.XUẤT(ĐVT)", "SL.CUỐI(Kg)", "SL.CUỐI(ĐVT)", "HSQD", "SL CARTON", "MÃ SPKM", "TÊN SPKM" };
				results.add(title);

				for (int i = 0; i < listTonKhoSanPham.size(); i++) {
					Object[] row = {
							listTonKhoSanPham.get(i).getProduct_type_code(),
							listTonKhoSanPham.get(i).getProduct_type_name(),
							listTonKhoSanPham.get(i).getPbrand_code(),
							listTonKhoSanPham.get(i).getPbrand_name(),
							listTonKhoSanPham.get(i).getLever_code(),
							listTonKhoSanPham.get(i).getProduct_code(),
							listTonKhoSanPham.get(i).getProduct_name(),
							listTonKhoSanPham.get(i).getKg_opening_balance(),
							MyMath.roundCustom(listTonKhoSanPham.get(i).getKg_opening_balance()
									/ listTonKhoSanPham.get(i).getFactor(), 2),
							listTonKhoSanPham.get(i).getKg_import_quantity(),
							MyMath.roundCustom(listTonKhoSanPham.get(i).getKg_import_quantity()
									/ listTonKhoSanPham.get(i).getFactor(), 2),
							listTonKhoSanPham.get(i).getKg_export_quantity(),
							MyMath.roundCustom(listTonKhoSanPham.get(i).getKg_export_quantity()
									/ listTonKhoSanPham.get(i).getFactor(), 2),
							listTonKhoSanPham.get(i).getKg_closing_balance(),
							MyMath.roundCustom(listTonKhoSanPham.get(i).getKg_closing_balance()
									/ listTonKhoSanPham.get(i).getFactor(), 2),
							listTonKhoSanPham.get(i).getFactor(),
							listTonKhoSanPham.get(i).getSpecification()/* cator */,
							listTonKhoSanPham.get(i).getPromotion_product_code() == null ? "" : listTonKhoSanPham
									.get(i).getPromotion_product_code(),
							listTonKhoSanPham.get(i).getPromotion_product_name() == null ? "" : listTonKhoSanPham
									.get(i).getPromotion_product_name() };
					results.add(row);

				}
				StringBuilder title2 = new StringBuilder();
				title2.append("tonsp_ ");
				if (fromDateSearch != null)
					title2.append("tu_ngay " + ToolTimeCustomer.convertDateToString(fromDateSearch, "dd/MM/yyyy"));
				if (toDateSearch != null)
					title2.append(" đến ngày " + ToolTimeCustomer.convertDateToString(toDateSearch, "dd/MM/yyyy"));
				ToolReport.printReportExcelRaw(results, title2.toString());
			} else {
				notify.warning("Không có dữ liệu");
			}
		} catch (Exception e) {
			logger.error("ReportTonKhoSanPhamBean.reportTonKhoSanPhamExcel:" + e.getMessage(), e);
		}
	}

	public double[] sumByType(long productTypeId) {
		double[] arr = { 0, 0, 0, 0, 0, 0, 0, 0, 0 };
		try {
			for (TonKhoSanPham p : listTonKhoSanPham) {
				if (p.getProduct_type_id() == productTypeId) {
					arr[0] += p.getUnit_opening_balance();
					arr[1] += p.getUnit_opening_balance() / p.getFactor();
					arr[2] += p.getKg_import_quantity();
					arr[3] += p.getKg_import_quantity() / p.getFactor();
					arr[4] += p.getKg_export_quantity();
					arr[5] += p.getUnit_export_quantity();
					arr[6] += p.getExport_total_amount();
					arr[7] += p.getKg_closing_balance();
					arr[8] += p.getKg_closing_balance() / p.getFactor();
				}
			}
			return arr;
		} catch (Exception e) {
			logger.error("ReportTonKhoThangBean.sumByType:" + e.getMessage(), e);
		}
		return arr;
	}

	@Override
	protected Logger getLogger() {
		return logger;
	}

	public Date getFromDateSearch() {
		return fromDateSearch;
	}

	public void setFromDateSearch(Date fromDateSearch) {
		this.fromDateSearch = fromDateSearch;
	}

	public Date getToDateSearch() {
		return toDateSearch;
	}

	public void setToDateSearch(Date toDateSearch) {
		this.toDateSearch = toDateSearch;
	}

	public Product getProductSearch() {
		return productSearch;
	}

	public void setProductSearch(Product productSearch) {
		this.productSearch = productSearch;
	}

	public ProductType getProductTypeSearch() {
		return productTypeSearch;
	}

	public void setProductTypeSearch(ProductType productTypeSearch) {
		this.productTypeSearch = productTypeSearch;
	}

	public List<ProductType> getListProductType() {
		return listProductType;
	}

	public void setListProductType(List<ProductType> listProductType) {
		this.listProductType = listProductType;
	}

	public int getTypep() {
		return typep;
	}

	public void setTypep(int typep) {
		this.typep = typep;
	}

	public List<TonKhoSanPham> getListTonKhoSanPham() {
		return listTonKhoSanPham;
	}

	public void setListTonKhoSanPham(List<TonKhoSanPham> listTonKhoSanPham) {
		this.listTonKhoSanPham = listTonKhoSanPham;
	}

	public List<TonKhoSanPham> getListTonKhoSanPhamFilter() {
		return listTonKhoSanPhamFilter;
	}

	public void setListTonKhoSanPhamFilter(List<TonKhoSanPham> listTonKhoSanPhamFilter) {
		this.listTonKhoSanPhamFilter = listTonKhoSanPhamFilter;
	}

	public FormatHandler getFormatHandler() {
		return formatHandler;
	}

	public void setFormatHandler(FormatHandler formatHandler) {
		this.formatHandler = formatHandler;
	}

}
